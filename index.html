<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TraderRecap Pro - Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-main: #0b0f1a;
            --card-bg: rgba(23, 30, 48, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-blue: #6366f1;
            --accent-emerald: #10b981;
            --accent-rose: #f43f5e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 35%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }

        /* 8 Columns: 1 for Week Label/Note + 7 for Days */
        .calendar-grid-wrapper {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 8px;
        }

        @media (min-width: 768px) {
            .calendar-grid-wrapper { gap: 12px; }
        }

        .calendar-day {
            aspect-ratio: 1 / 1.1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: rgba(51, 65, 85, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .calendar-day.today {
            border: 2px solid var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }

        .calendar-day.has-profit {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .calendar-day.has-loss {
            background: rgba(244, 63, 94, 0.1);
            border-color: rgba(244, 63, 94, 0.2);
        }

        .week-note-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            color: #475569;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .week-note-btn.has-note {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.4);
            color: var(--accent-blue);
        }

        .week-note-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .pnl-indicator {
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 4px;
            border-radius: 4px;
            text-align: center;
            width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .pnl-indicator { font-size: 0.75rem; padding: 2px 6px; }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .hidden-section { display: none !important; }
        
        .sync-pulse {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-[#0b0f1a] flex items-center justify-center z-[200]">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-500 mb-4"></div>
            <p class="text-slate-400 text-xs font-bold tracking-widest uppercase">Sinkronisasi...</p>
        </div>
    </div>

    <div class="max-w-2xl w-full">
        
        <!-- LOGIN SECTION (Sama Seperti Sebelumnya) -->
        <div id="auth-section" class="hidden-section max-w-md mx-auto mt-10">
            <div class="glass-card p-8 md:p-10 rounded-[2rem]">
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <h2 id="auth-title" class="text-3xl font-black text-white">TraderRecap</h2>
                    <p class="text-slate-400 text-sm mt-2">Sinkronisasi data ke cloud.</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="email" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Email">
                    <input type="password" id="password" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Password">
                    <p id="auth-error" class="text-rose-400 text-xs text-center hidden p-3 bg-rose-500/10 rounded-lg border border-rose-500/20"></p>
                    <button id="btn-action" class="btn-primary w-full text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">Lanjutkan</button>
                    <button id="toggle-auth" class="w-full text-indigo-400 text-sm font-medium mt-2">Belum punya akun? Daftar</button>
                    <div class="flex items-center gap-4 my-4"><div class="h-px bg-slate-800 flex-1"></div><span class="text-slate-600 text-[10px] font-bold">ATAU</span><div class="h-px bg-slate-800 flex-1"></div></div>
                    <button id="btn-guest" class="w-full bg-slate-800 text-slate-300 font-bold py-4 rounded-xl border border-slate-700 transition active:scale-95">Mode Tamu</button>
                </div>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="app-section" class="hidden-section w-full">
            <header class="mb-6 flex flex-wrap gap-4 justify-between items-center glass-card p-5 rounded-3xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600/20 rounded-xl flex items-center justify-center border border-indigo-500/30 text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    </div>
                    <div>
                        <h1 id="month-display" class="text-xl font-bold text-white leading-none mb-1">Mei 2024</h1>
                        <p id="user-display" class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">Trader</p>
                    </div>
                </div>
                
                <div class="flex items-center bg-slate-900 p-1 rounded-xl">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    <div class="w-px h-4 bg-slate-800 mx-1"></div>
                    <button onclick="handleLogout()" class="p-2 text-rose-400 hover:bg-rose-500/10 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" /></svg></button>
                </div>
            </header>

            <!-- Stat Boxes -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-indigo-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Profit Minggu Ini</p>
                    <p id="weekly-pnl" class="text-2xl font-black tabular-nums">$0.00</p>
                </div>
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-emerald-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Profit Bulan Ini</p>
                    <p id="monthly-pnl" class="text-2xl font-black tabular-nums">$0.00</p>
                </div>
            </div>

            <!-- Calendar -->
            <div class="glass-card p-5 md:p-6 rounded-[2rem]">
                <div class="calendar-grid-wrapper text-center text-[10px] font-black text-slate-600 mb-4 uppercase">
                    <div class="flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></div>
                    <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                </div>
                <div id="calendar-body" class="calendar-grid-wrapper"></div>
            </div>

            <!-- Sync Info -->
            <div class="mt-8 flex justify-center">
                 <div class="flex items-center gap-2 px-4 py-2 bg-slate-900 rounded-full border border-slate-800">
                    <div id="sync-dot" class="w-2 h-2 bg-slate-500 rounded-full"></div>
                    <span id="sync-status" class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Offline</span>
                 </div>
            </div>
        </div>
    </div>

    <!-- MODAL PNL -->
    <div id="modal-pnl" class="modal-overlay">
        <div class="glass-card p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h3 id="modal-date-label" class="text-xl font-bold text-white mb-1">Tanggal</h3>
            <p class="text-slate-400 text-xs mb-6">Input Profit atau Loss Anda.</p>
            <input type="number" id="pnl-input" step="0.01" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-xl font-bold text-white focus:ring-2 focus:ring-indigo-500 outline-none mb-4" placeholder="0.00">
            <div class="flex flex-col gap-2">
                <button id="btn-save-pnl" class="btn-primary w-full py-4 rounded-xl font-bold text-white shadow-xl active:scale-95">SIMPAN</button>
                <button id="btn-delete-pnl" class="w-full py-2 text-rose-500 font-bold text-sm hidden">Hapus Data</button>
                <button onclick="closeModals()" class="w-full py-2 text-slate-500 text-xs">Batal</button>
            </div>
        </div>
    </div>

    <!-- MODAL WEEKLY NOTE -->
    <div id="modal-note" class="modal-overlay">
        <div class="glass-card p-8 rounded-3xl w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 id="modal-week-label" class="text-xl font-bold text-white mb-1">Weekly Review</h3>
                    <p class="text-slate-400 text-xs">Evaluasi performa dan psikologi minggu ini.</p>
                </div>
                <div id="week-pnl-summary" class="px-3 py-1 bg-indigo-500/20 rounded-lg text-indigo-400 font-black text-sm">+$0.00</div>
            </div>
            <textarea id="note-input" class="w-full h-48 bg-slate-950 border border-slate-800 rounded-xl p-4 text-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none mb-4 resize-none" placeholder="Tuliskan catatan penting, kesalahan, atau rencana perbaikan..."></textarea>
            <div class="flex gap-3">
                <button id="btn-save-note" class="btn-primary flex-1 py-4 rounded-xl font-bold text-white shadow-xl active:scale-95 text-sm uppercase">Simpan Review</button>
                <button onclick="closeModals()" class="bg-slate-800 text-slate-400 px-6 rounded-xl font-bold text-xs uppercase hover:bg-slate-700 transition">Tutup</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARhUT6jldJ8SwVyRx9vQTVc6n0UzqiAOw",
            authDomain: "kalender-recap.firebaseapp.com",
            projectId: "kalender-recap",
            storageBucket: "kalender-recap.firebasestorage.app",
            messagingSenderId: "603264142144",
            appId: "1:603264142144:web:e516baec2acebe0e0a08a5"
        };

        const currentAppId = "trader-recap-sync-v1";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let trades = {};
        let weeklyNotes = {};
        let currentMonth = new Date();
        let selectedDateStr = "";
        let selectedWeekId = "";
        let isRegisterMode = false;
        let unsubscribe = null;

        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const el = (id) => document.getElementById(id);

        onAuthStateChanged(auth, (u) => {
            el('loading-screen').classList.add('hidden-section');
            user = u;
            if (u) {
                el('auth-section').classList.add('hidden-section');
                el('app-section').classList.remove('hidden-section');
                el('user-display').textContent = u.isAnonymous ? "GUEST MODE" : u.email.split('@')[0].toUpperCase();
                startSync();
            } else {
                el('app-section').classList.add('hidden-section');
                el('auth-section').classList.remove('hidden-section');
                if (unsubscribe) unsubscribe();
            }
        });

        // Auth Logic
        el('btn-action').onclick = async () => {
            const email = el('email').value;
            const pass = el('password').value;
            if (!email || !pass) return;
            try {
                el('auth-error').classList.add('hidden');
                if (isRegisterMode) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                el('auth-error').textContent = err.message;
                el('auth-error').classList.remove('hidden');
            }
        };
        el('btn-guest').onclick = () => signInAnonymously(auth);
        el('toggle-auth').onclick = () => {
            isRegisterMode = !isRegisterMode;
            el('auth-title').textContent = isRegisterMode ? "Daftar Akun" : "Masuk Akun";
            el('toggle-auth').textContent = isRegisterMode ? "Login di sini" : "Daftar di sini";
        };
        window.handleLogout = () => signOut(auth);

        // Sync Logic
        function startSync() {
            const docRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                trades = data.records || {};
                weeklyNotes = data.weeklyNotes || {};
                renderCalendar();
                el('sync-dot').className = "w-2 h-2 bg-emerald-500 rounded-full sync-pulse";
                el('sync-status').textContent = "Synced";
            }, (err) => {
                el('sync-dot').className = "w-2 h-2 bg-rose-500 rounded-full";
                el('sync-status').textContent = "Sync Error";
            });
        }

        window.changeMonth = (v) => {
            currentMonth.setMonth(currentMonth.getMonth() + v);
            renderCalendar();
        };

        function getWeekId(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}-W${weekNo}`;
        }

        function renderCalendar() {
            const body = el('calendar-body');
            body.innerHTML = '';
            const yr = currentMonth.getFullYear();
            const mo = currentMonth.getMonth();
            el('month-display').textContent = `${months[mo]} ${yr}`;

            const firstDay = new Date(yr, mo, 1).getDay();
            const daysInMonth = new Date(yr, mo + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            let dateCounter = 1;
            let currentWeekDays = [];

            // Loop per baris minggu
            for (let row = 0; row < 6; row++) {
                if (dateCounter > daysInMonth && row > 0) break;

                // 1. Tombol Note di awal baris (Samping Kalender)
                const weekStartDate = new Date(yr, mo, dateCounter - (row === 0 ? firstDay : 0));
                const weekId = getWeekId(weekStartDate);
                
                const noteBtn = document.createElement('div');
                noteBtn.className = `week-note-btn ${weeklyNotes[weekId] ? 'has-note' : ''}`;
                noteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                `;
                noteBtn.onclick = () => openNoteModal(weekId, weekStartDate);
                body.appendChild(noteBtn);

                // 2. Loop 7 hari dalam baris tersebut
                for (let col = 0; col < 7; col++) {
                    const dayIdx = row * 7 + col;
                    const dayEl = document.createElement('div');
                    
                    if (dayIdx < firstDay || dateCounter > daysInMonth) {
                        dayEl.className = 'calendar-day opacity-10 pointer-events-none';
                        dayEl.innerHTML = '';
                    } else {
                        const dStr = `${yr}-${String(mo + 1).padStart(2, '0')}-${String(dateCounter).padStart(2, '0')}`;
                        dayEl.className = 'calendar-day';
                        if (dStr === todayStr) dayEl.classList.add('today');

                        const val = trades[dStr];
                        if (val !== undefined) {
                            dayEl.classList.add(val >= 0 ? 'has-profit' : 'has-loss');
                            dayEl.innerHTML = `
                                <span class="text-[10px] text-slate-500 font-bold">${dateCounter}</span>
                                <div class="pnl-indicator ${val >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                                    ${val >= 0 ? '+' : ''}${val}
                                </div>
                            `;
                        } else {
                            dayEl.innerHTML = `<span class="text-xs font-bold text-slate-400">${dateCounter}</span>`;
                        }
                        dayEl.onclick = () => openPnlModal(dStr);
                        dateCounter++;
                    }
                    body.appendChild(dayEl);
                }
            }
            updateStats();
        }

        // PNL Modal
        function openPnlModal(dateStr) {
            selectedDateStr = dateStr;
            const val = trades[dateStr];
            el('modal-date-label').textContent = new Date(dateStr).toLocaleDateString('id-ID', { day:'numeric', month:'long' });
            el('pnl-input').value = val !== undefined ? val : '';
            el('btn-delete-pnl').classList.toggle('hidden', val === undefined);
            el('modal-pnl').classList.add('active');
        }

        // Note Modal
        function openNoteModal(weekId, startDate) {
            selectedWeekId = weekId;
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            el('modal-week-label').textContent = `Review Minggu Ke-${weekId.split('W')[1]}`;
            el('note-input').value = weeklyNotes[weekId] || '';
            
            // Hitung PNL Minggu tersebut
            let weekSum = 0;
            const start = new Date(startDate); start.setHours(0,0,0,0);
            const end = new Date(endDate); end.setHours(23,59,59,999);

            Object.entries(trades).forEach(([dStr, val]) => {
                const d = new Date(dStr);
                if (d >= start && d <= end) weekSum += val;
            });

            const sumEl = el('week-pnl-summary');
            sumEl.textContent = (weekSum >= 0 ? '+$' : '-$') + Math.abs(weekSum).toFixed(2);
            sumEl.className = `px-3 py-1 rounded-lg font-black text-sm ${weekSum >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`;

            el('modal-note').classList.add('active');
        }

        window.closeModals = () => {
            el('modal-pnl').classList.remove('active');
            el('modal-note').classList.remove('active');
        };

        // Actions
        el('btn-save-pnl').onclick = async () => {
            const val = parseFloat(el('pnl-input').value);
            if (isNaN(val)) return;
            const docRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            await setDoc(docRef, { records: { [selectedDateStr]: val } }, { merge: true });
            closeModals();
        };

        el('btn-delete-pnl').onclick = async () => {
            const docRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            await updateDoc(docRef, { [`records.${selectedDateStr}`]: deleteField() });
            closeModals();
        };

        el('btn-save-note').onclick = async () => {
            const txt = el('note-input').value;
            const docRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            await setDoc(docRef, { weeklyNotes: { [selectedWeekId]: txt } }, { merge: true });
            closeModals();
        };

        function updateStats() {
            let weekSum = 0, monthSum = 0;
            const now = new Date();
            const weekLimit = new Date(); weekLimit.setDate(now.getDate() - 7);

            Object.entries(trades).forEach(([dateStr, val]) => {
                const d = new Date(dateStr);
                if (d.getMonth() === currentMonth.getMonth() && d.getFullYear() === currentMonth.getFullYear()) monthSum += val;
                if (d >= weekLimit && d <= now) weekSum += val;
            });

            const fmt = (id, v) => {
                const item = el(id);
                item.textContent = (v >= 0 ? '+$' : '-$') + Math.abs(v).toFixed(2);
                item.className = `text-2xl font-black tabular-nums ${v >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            };
            fmt('weekly-pnl', weekSum);
            fmt('monthly-pnl', monthSum);
        }
    </script>
</body>
</html>
