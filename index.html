<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TraderRecap Pro - Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-main: #0b0f1a;
            --card-bg: rgba(23, 30, 48, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-blue: #6366f1;
            --accent-emerald: #10b981;
            --accent-rose: #f43f5e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 35%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        @media (min-width: 768px) {
            .calendar-grid { gap: 12px; }
        }

        .calendar-day {
            aspect-ratio: 1 / 1.1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: rgba(51, 65, 85, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .calendar-day.today {
            border: 1.5px solid var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }

        .calendar-day.has-profit {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .calendar-day.has-loss {
            background: rgba(244, 63, 94, 0.1);
            border-color: rgba(244, 63, 94, 0.2);
        }

        .pnl-indicator {
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 4px;
            border-radius: 4px;
            text-align: center;
            width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .pnl-indicator { font-size: 0.75rem; padding: 2px 6px; }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .hidden-section { display: none !important; }
        
        .sync-pulse {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-[#0b0f1a] flex items-center justify-center z-[200]">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-500 mb-4"></div>
            <p class="text-slate-400 text-xs font-bold tracking-widest uppercase">Sinkronisasi Awan...</p>
        </div>
    </div>

    <div class="max-w-xl w-full">
        
        <!-- LOGIN/AUTH -->
        <div id="auth-section" class="hidden-section max-w-md mx-auto mt-10">
            <div class="glass-card p-8 md:p-10 rounded-[2rem]">
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <h2 id="auth-title" class="text-3xl font-black text-white">Masuk Akun</h2>
                    <p class="text-slate-400 text-sm mt-2">Data Anda akan sinkron di semua device.</p>
                </div>

                <div class="space-y-4">
                    <input type="email" id="email" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Email">
                    <input type="password" id="password" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Password">
                    
                    <p id="auth-error" class="text-rose-400 text-xs text-center hidden p-3 bg-rose-500/10 rounded-lg border border-rose-500/20"></p>

                    <button id="btn-action" class="btn-primary w-full text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">
                        Lanjutkan
                    </button>

                    <button id="toggle-auth" class="w-full text-indigo-400 text-sm font-medium mt-2">
                        Belum punya akun? Daftar
                    </button>

                    <div class="flex items-center gap-4 my-4">
                        <div class="h-px bg-slate-800 flex-1"></div>
                        <span class="text-slate-600 text-[10px] font-bold uppercase tracking-widest">Atau</span>
                        <div class="h-px bg-slate-800 flex-1"></div>
                    </div>

                    <button id="btn-guest" class="w-full bg-slate-800 text-slate-300 font-bold py-4 rounded-xl border border-slate-700 transition active:scale-95">
                        Mode Tamu (Lokal)
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="app-section" class="hidden-section w-full">
            <header class="mb-6 flex flex-wrap gap-4 justify-between items-center glass-card p-5 rounded-3xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600/20 rounded-xl flex items-center justify-center border border-indigo-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h1 id="month-display" class="text-xl font-bold text-white leading-none mb-1">Mei 2024</h1>
                        <p id="user-display" class="text-slate-500 text-[10px] uppercase font-bold tracking-tighter">Trader</p>
                    </div>
                </div>
                
                <div class="flex items-center bg-slate-900 p-1 rounded-xl">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    <div class="w-px h-4 bg-slate-800 mx-1"></div>
                    <button onclick="handleLogout()" class="p-2 text-rose-400 hover:bg-rose-500/10 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" /></svg></button>
                </div>
            </header>

            <!-- Stat Boxes -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-indigo-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Profit Minggu Ini</p>
                    <p id="weekly-pnl" class="text-2xl font-black tabular-nums">$0.00</p>
                </div>
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-emerald-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Profit Bulan Ini</p>
                    <p id="monthly-pnl" class="text-2xl font-black tabular-nums">$0.00</p>
                </div>
            </div>

            <!-- Calendar -->
            <div class="glass-card p-5 md:p-6 rounded-[2rem]">
                <div class="calendar-grid text-center text-[10px] font-black text-slate-600 mb-4 uppercase">
                    <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
            </div>

            <!-- Footer Sync Status -->
            <div class="mt-8 flex justify-center">
                 <div class="flex items-center gap-2 px-4 py-2 bg-slate-900 rounded-full border border-slate-800">
                    <div id="sync-dot" class="w-2 h-2 bg-slate-500 rounded-full"></div>
                    <span id="sync-status" class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Offline</span>
                 </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal-overlay">
        <div class="glass-card p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h3 id="modal-date-label" class="text-xl font-bold text-white mb-1">Tanggal</h3>
            <p class="text-slate-400 text-xs mb-6">Input Profit (Positif) atau Loss (Negatif).</p>
            
            <div class="space-y-4">
                <input type="number" id="pnl-input" step="0.01" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-xl font-bold text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0.00">
                
                <div class="flex flex-col gap-2">
                    <button id="btn-save" class="btn-primary w-full py-4 rounded-xl font-bold text-white shadow-xl active:scale-95">SIMPAN DATA</button>
                    <button id="btn-delete" class="w-full py-4 text-rose-500 font-bold text-sm hidden">Hapus Data Hari Ini</button>
                    <button onclick="closeModal()" class="w-full py-2 text-slate-500 text-xs">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyARhUT6jldJ8SwVyRx9vQTVc6n0UzqiAOw",
            authDomain: "kalender-recap.firebaseapp.com",
            projectId: "kalender-recap",
            storageBucket: "kalender-recap.firebasestorage.app",
            messagingSenderId: "603264142144",
            appId: "1:603264142144:web:e516baec2acebe0e0a08a5"
        };

        const currentAppId = "trader-recap-sync-v1";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let trades = {};
        let currentMonth = new Date();
        let selectedDateStr = "";
        let isRegisterMode = false;
        let unsubscribe = null;

        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // UI Helpers
        const el = (id) => document.getElementById(id);

        onAuthStateChanged(auth, (u) => {
            el('loading-screen').classList.add('hidden-section');
            user = u;
            if (u) {
                el('auth-section').classList.add('hidden-section');
                el('app-section').classList.remove('hidden-section');
                el('user-display').textContent = u.isAnonymous ? "Mode Tamu" : u.email;
                startSync();
            } else {
                el('app-section').classList.add('hidden-section');
                el('auth-section').classList.remove('hidden-section');
                if (unsubscribe) unsubscribe();
            }
        });

        // Auth Actions
        el('btn-action').onclick = async () => {
            const email = el('email').value;
            const pass = el('password').value;
            if (!email || !pass) return;

            try {
                el('auth-error').classList.add('hidden');
                if (isRegisterMode) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                el('auth-error').textContent = "Kesalahan: " + err.message;
                el('auth-error').classList.remove('hidden');
            }
        };

        el('btn-guest').onclick = () => signInAnonymously(auth);
        el('toggle-auth').onclick = () => {
            isRegisterMode = !isRegisterMode;
            el('auth-title').textContent = isRegisterMode ? "Daftar Akun" : "Masuk Akun";
            el('toggle-auth').textContent = isRegisterMode ? "Sudah punya akun? Login" : "Belum punya akun? Daftar";
        };
        window.handleLogout = () => signOut(auth);

        // Sync Logic
        function startSync() {
            const userDocRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            
            unsubscribe = onSnapshot(userDocRef, (doc) => {
                trades = doc.exists() ? (doc.data().records || {}) : {};
                renderCalendar();
                el('sync-dot').className = "w-2 h-2 bg-emerald-500 rounded-full sync-pulse";
                el('sync-status').textContent = "Tersinkron";
            }, (err) => {
                console.error(err);
                el('sync-dot').className = "w-2 h-2 bg-rose-500 rounded-full";
                el('sync-status').textContent = "Gagal Sinkron";
            });
        }

        // Calendar Logic
        window.changeMonth = (val) => {
            currentMonth.setMonth(currentMonth.getMonth() + val);
            renderCalendar();
        };

        function renderCalendar() {
            const body = el('calendar-body');
            body.innerHTML = '';
            
            const yr = currentMonth.getFullYear();
            const mo = currentMonth.getMonth();
            el('month-display').textContent = `${months[mo]} ${yr}`;

            const firstDay = new Date(yr, mo, 1).getDay();
            const daysInMonth = new Date(yr, mo + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < firstDay; i++) body.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                // Gunakan template literal agar format tanggal konsisten di semua browser
                const dStr = `${yr}-${String(mo + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if (dStr === todayStr) dayEl.classList.add('today');

                const val = trades[dStr];
                if (val !== undefined) {
                    dayEl.classList.add(val >= 0 ? 'has-profit' : 'has-loss');
                    dayEl.innerHTML = `
                        <span class="text-[10px] text-slate-500 font-bold">${d}</span>
                        <div class="pnl-indicator ${val >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                            ${val >= 0 ? '+' : ''}${val}
                        </div>
                    `;
                } else {
                    dayEl.innerHTML = `<span class="text-xs font-bold text-slate-400">${d}</span>`;
                }

                dayEl.onclick = () => openModal(dStr);
                body.appendChild(dayEl);
            }
            updateStats();
        }

        // Modal & Save
        window.openModal = (dateStr) => {
            selectedDateStr = dateStr;
            const hasData = trades[dateStr] !== undefined;
            const dateObj = new Date(dateStr);
            el('modal-date-label').textContent = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            el('pnl-input').value = hasData ? trades[dateStr] : '';
            el('btn-delete').classList.toggle('hidden', !hasData);
            el('modal').classList.add('active');
            setTimeout(() => el('pnl-input').focus(), 100);
        };

        window.closeModal = () => el('modal').classList.remove('active');

        async function save(isDelete = false) {
            if (!user) return;
            const userDocRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'trades_data');
            const val = parseFloat(el('pnl-input').value);

            try {
                if (isDelete) {
                    await updateDoc(userDocRef, { [`records.${selectedDateStr}`]: deleteField() });
                } else if (!isNaN(val)) {
                    await setDoc(userDocRef, { records: { [selectedDateStr]: val } }, { merge: true });
                }
                closeModal();
            } catch (e) {
                alert("Gagal menyimpan data ke cloud.");
            }
        }

        el('btn-save').onclick = () => save(false);
        el('btn-delete').onclick = () => save(true);

        function updateStats() {
            let weekSum = 0, monthSum = 0;
            const now = new Date();
            const weekLimit = new Date(); weekLimit.setDate(now.getDate() - 7);

            Object.entries(trades).forEach(([dateStr, val]) => {
                const d = new Date(dateStr);
                if (d.getMonth() === currentMonth.getMonth() && d.getFullYear() === currentMonth.getFullYear()) monthSum += val;
                if (d >= weekLimit && d <= now) weekSum += val;
            });

            const format = (id, v) => {
                const item = el(id);
                item.textContent = (v >= 0 ? '+$' : '-$') + Math.abs(v).toFixed(2);
                item.className = `text-2xl font-black tabular-nums ${v >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            };
            format('weekly-pnl', weekSum);
            format('monthly-pnl', monthSum);
        }
    </script>
</body>
</html>
